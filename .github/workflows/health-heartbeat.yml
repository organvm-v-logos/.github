name: Health Heartbeat

on:
  schedule:
    - cron: "0 12 * * 1"  # Monday 12:00 UTC
  workflow_dispatch:

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check pipeline health
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_DISPATCH_TOKEN }}
        run: |
          FAILURES=""
          WEEK_AGO=$(date -u -v-7d +%Y-%m-%dT00:00:00Z 2>/dev/null || date -u -d "7 days ago" +%Y-%m-%dT00:00:00Z)

          check_workflow() {
            local repo="$1"
            local workflow="$2"
            local label="$3"

            RESULT=$(gh api "repos/organvm-v-logos/$repo/actions/workflows/$workflow/runs?per_page=1&created=>=$WEEK_AGO" \
              --jq '.workflow_runs[0].conclusion // "none"' 2>/dev/null || echo "error")

            if [ "$RESULT" != "success" ]; then
              FAILURES="$FAILURES\n- **$label** ($repo/$workflow): $RESULT"
              echo "FAIL: $label = $RESULT"
            else
              echo "OK: $label"
            fi
          }

          # Check weekly pipelines
          check_workflow "analytics-engine" "weekly-metrics.yml" "Weekly Metrics"
          check_workflow "reading-observatory" "weekly-feeds.yml" "Weekly Feeds"
          check_workflow "essay-pipeline" "weekly-intelligence.yml" "Weekly Intelligence"

          # Check for merged essay PRs this week
          MERGED_COUNT=$(gh api "repos/organvm-v-logos/public-process/pulls?state=closed&sort=updated&direction=desc&per_page=20" \
            --jq "[.[] | select(.merged_at != null and .merged_at >= \"$WEEK_AGO\" and (.labels | any(.name == \"auto-draft\")))] | length" 2>/dev/null || echo "0")

          if [ "$MERGED_COUNT" = "0" ]; then
            FAILURES="$FAILURES\n- **Essay Publication**: No auto-draft PRs merged this week"
            echo "FAIL: No essays merged"
          else
            echo "OK: $MERGED_COUNT essay PR(s) merged"
          fi

          # Create issue if any failures
          if [ -n "$FAILURES" ]; then
            BODY=$(cat <<EOF
          ## ORGAN-V Autonomous Pipeline Health Check Failed

          The following checks failed during the weekly heartbeat:

          $(echo -e "$FAILURES")

          ### Diagnostics
          - Check run: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Period checked: since $WEEK_AGO

          ### Resolution
          1. Check the workflow logs for each failing pipeline
          2. Verify secrets are still valid (API keys, tokens)
          3. Re-run failed workflows manually via GitHub Actions UI

          ---
          *Generated by health-heartbeat workflow*
          EOF
          )

            gh api repos/organvm-v-logos/.github/issues \
              -f title="[Health] Pipeline stall detected — $(date -u +%Y-%m-%d)" \
              -f body="$BODY" \
              -f "labels[]=automation" \
              -f "labels[]=health-check"

            echo "Health check FAILED — issue created"
            exit 1
          else
            echo "All health checks passed"
          fi
